"use strict";Object.defineProperty(exports,"t",{value:true});var HANDSHAKE="handshake";var HANDSHAKE_REPLY="handshake-reply";var CALL="call";var REPLY="reply";var FULFILLED="fulfilled";var REJECTED="rejected";var MESSAGE="message";var DATA_CLONE_ERROR="DataCloneError";var ERR_CONNECTION_DESTROYED="ConnectionDestroyed";var ERR_CONNECTION_TIMEOUT="ConnectionTimeout";var ERR_NOT_IN_IFRAME="NotInIframe";var ERR_IFRAME_ALREADY_ATTACHED_TO_DOM="IframeAlreadyAttachedToDom";var CHECK_IFRAME_IN_DOC_INTERVAL=6e4;var DEFAULT_PORTS={o:"80",i:"443"};var URL_REGEX=/^(https?:|file:)?\/\/([^\/:]+)?(:(\d+))?/;var Penpal={l:ERR_CONNECTION_DESTROYED,v:ERR_CONNECTION_TIMEOUT,u:ERR_NOT_IN_IFRAME,R:ERR_IFRAME_ALREADY_ATTACHED_TO_DOM,Promise:function(){try{return window?window.Promise:null}catch(r){return null}}(),debug:false};var generateId=function(){var r=0;return function(){return++r}}();var log=function r(){if(Penpal.debug){var e;for(var n=arguments.length,a=new Array(n),t=0;t<n;t++){a[t]=arguments[t]}(e=console).log.apply(e,["[Penpal]"].concat(a))}};var getOriginFromUrl=function r(e){var n=document.location;var a=URL_REGEX.exec(e);var t;var o;var E;if(a){t=a[1]?a[1]:n.protocol;o=a[2];E=a[4]}else{t=n.protocol;o=n.hostname;E=n.port}if(t==="file:"){return"null"}var i=E&&E!==DEFAULT_PORTS[t]?":".concat(E):"";return"".concat(t,"//").concat(o).concat(i)};var DestructionPromise=function r(e){var n=[];e(function(){n.forEach(function(r){r()})});return{then:function r(e){n.push(e)}}};var serializeError=function r(e){var n=e.name,a=e.message,t=e.stack;return{name:n,message:a,stack:t}};var deserializeError=function r(e){var n=new Error;Object.keys(e).forEach(function(r){return n[r]=e[r]});return n};var connectCallSender=function r(e,n,a,t,o){var E=n.localName,i=n._,c=n.T,l=n.O;var v=false;log("".concat(E,": Connecting call sender"));var u=function r(e){return function(){for(var r=arguments.length,n=new Array(r),a=0;a<r;a++){n[a]=arguments[a]}log("".concat(E,": Sending ").concat(e,"() call"));if(c.closed){t()}if(v){var o=new Error("Unable to send ".concat(e,"() call due ")+"to destroyed connection");o.code=ERR_CONNECTION_DESTROYED;throw o}return new Penpal.Promise(function(r,a){var t=generateId();var o=function n(o){if(o.source===c&&o.origin===l&&o.data.A===REPLY&&o.data.id===t){log("".concat(E,": Received ").concat(e,"() reply"));i.removeEventListener(MESSAGE,n);var v=o.data.returnValue;if(o.data.N){v=deserializeError(v)}(o.data.C===FULFILLED?r:a)(v)}};i.addEventListener(MESSAGE,o);c.postMessage({A:CALL,id:t,s:e,D:n},l)})}};o.then(function(){v=true});a.reduce(function(r,e){r[e]=u(e);return r},e)};var connectCallReceiver=function r(e,n,a){var t=e.localName,o=e._,E=e.T,i=e.O;var c=false;log("".concat(t,": Connecting call receiver"));var l=function r(e){if(e.source===E&&e.origin===i&&e.data.A===CALL){var a=e.data,o=a.s,l=a.D,v=a.id;log("".concat(t,": Received ").concat(o,"() call"));if(o in n){var u=function r(e){return function(r){log("".concat(t,": Sending ").concat(o,"() reply"));if(c){log("".concat(t,": Unable to send ").concat(o,"() reply due to destroyed connection"));return}var n={A:REPLY,id:v,C:e,returnValue:r};if(e===REJECTED&&r instanceof Error){n.returnValue=serializeError(r);n.N=true}try{E.postMessage(n,i)}catch(r){if(r.name===DATA_CLONE_ERROR){E.postMessage({A:REPLY,id:v,C:REJECTED,returnValue:serializeError(r),N:true},i)}throw r}}};new Penpal.Promise(function(r){return r(n[o].apply(n,l))}).then(u(FULFILLED),u(REJECTED))}}};o.addEventListener(MESSAGE,l);a.then(function(){c=true;o.removeEventListener(MESSAGE,l)})};Penpal.I=function(r){var e=r.url,n=r.m,a=r.S,t=r.L,o=t===void 0?{}:t,E=r.timeout;if(a&&a.parentNode){var i=new Error("connectToChild() must not be called with an iframe already attached to DOM");i.code=ERR_IFRAME_ALREADY_ATTACHED_TO_DOM;throw i}var c;var l=new DestructionPromise(function(r){c=r});var v=window;a=a||document.createElement("iframe");a.src=e;var u=getOriginFromUrl(e);var R=new Penpal.Promise(function(r,e){var t;if(E!==undefined){t=setTimeout(function(){var r=new Error("Connection to child timed out after ".concat(E,"ms"));r.code=ERR_CONNECTION_TIMEOUT;e(r);c()},E)}var i={};var R;var _;var f=function e(n){var E=a.contentWindow;if(n.source===E&&n.origin===u&&n.data.A===HANDSHAKE){log("Parent: Received handshake, sending reply");var f=n.origin==="null"?"*":n.origin;n.source.postMessage({A:HANDSHAKE_REPLY,M:Object.keys(o)},f);var d={localName:"Parent",_:v,T:E,O:f};if(_){_()}var T=new DestructionPromise(function(r){l.then(r);_=r});connectCallReceiver(d,o,T);if(R){R.forEach(function(r){delete i[r]})}R=n.data.M;connectCallSender(i,d,R,c,l);clearTimeout(t);r(i)}};v.addEventListener(MESSAGE,f);log("Parent: Loading iframe");(n||document.body).appendChild(a);var d=setInterval(function(){if(!document.contains(a)){clearInterval(d);c()}},CHECK_IFRAME_IN_DOC_INTERVAL);l.then(function(){if(a.parentNode){a.parentNode.removeChild(a)}v.removeEventListener(MESSAGE,f);clearInterval(d);var r=new Error("Connection destroyed");r.code=ERR_CONNECTION_DESTROYED;e(r)})});return{p:R,S:a,h:c}};Penpal.P=function(){var r=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{},e=r.g,n=e===void 0?"*":e,a=r.L,t=a===void 0?{}:a,o=r.timeout;if(window===window.top){var E=new Error("connectToParent() must be called within an iframe");E.code=ERR_NOT_IN_IFRAME;throw E}var i;var c=new DestructionPromise(function(r){i=r});var l=window;var v=l.parent;var u=new Penpal.Promise(function(r,e){var a;if(o!==undefined){a=setTimeout(function(){var r=new Error("Connection to parent timed out after ".concat(o,"ms"));r.code=ERR_CONNECTION_TIMEOUT;e(r);i()},o)}var E=function e(o){if((n==="*"||n===o.origin)&&o.source===v&&o.data.A===HANDSHAKE_REPLY){log("Child: Received handshake reply");l.removeEventListener(MESSAGE,e);var E={localName:"Child",_:l,T:v,O:o.origin};var u={};connectCallReceiver(E,t,c);connectCallSender(u,E,o.data.M,i,c);clearTimeout(a);r(u)}};l.addEventListener(MESSAGE,E);c.then(function(){l.removeEventListener(MESSAGE,E);var r=new Error("Connection destroyed");r.code=ERR_CONNECTION_DESTROYED;e(r)});log("Child: Sending handshake");v.postMessage({A:HANDSHAKE,M:Object.keys(t)},n)});return{p:u,h:i}};exports.l=ERR_CONNECTION_DESTROYED;exports.v=ERR_CONNECTION_TIMEOUT;exports.u=ERR_NOT_IN_IFRAME;exports.R=ERR_IFRAME_ALREADY_ATTACHED_TO_DOM;exports.default=Penpal;